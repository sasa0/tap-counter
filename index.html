<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#111827" />
  <title>Shared Tap Counter</title>
  <style>
    :root { --bg:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --disabled:#334155; }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,sans-serif; background:var(--bg); color:var(--fg); }
    .wrap{ min-height:100%; display:grid; place-items:center; padding:24px; }
    .card{ width:100%; max-width:560px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:20px; padding:24px; text-align:center; box-shadow:0 10px 25px rgba(0,0,0,0.3); }
    .title{ font-size:14px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted); margin-bottom:10px; }
    .last{ font-size:18px; margin-bottom:20px; color:var(--fg); }
    .count{ font-size:clamp(64px,16vw,120px); font-weight:800; margin:10px 0 24px; line-height:1; }
    .btn{ display:inline-grid; place-items:center; width:160px; height:160px; border-radius:50%; font-size:22px; font-weight:700; border:none; background:var(--accent); color:#062a12; cursor:pointer; transition:transform .06s ease,opacity .2s ease; -webkit-tap-highlight-color:transparent; user-select:none; }
    .btn:active{ transform:scale(.98); }
    .btn[disabled]{ background:var(--disabled); color:#9ca3af; cursor:not-allowed; opacity:.8; }
    .hint{ margin-top:14px; color:var(--muted); font-size:14px; min-height:20px; }
    .footer{ margin-top:26px; font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">Last Tap (CET/Belgrade)</div>
      <div id="last" class="last">Never</div>
      <div id="count" class="count">0</div>
      <button id="tap" class="btn" aria-live="polite">Tap</button>
      <div id="hint" class="hint"></div>
      <div class="footer">Shared state via Firebase â€¢ Add to home screen</div>
    </div>
  </div>

  <!-- Firebase SDKs and app logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, doc, getDoc, onSnapshot, runTransaction } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // TODO: replace with your Firebase project config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const counterRef = doc(db, 'counter', 'state'); // a single document to hold count/state

    const LOCK_MS = 5 * 60 * 1000;
    const TZ = 'Europe/Belgrade';
    const elCount = document.getElementById('count');
    const elLast  = document.getElementById('last');
    const elTap   = document.getElementById('tap');
    const elHint  = document.getElementById('hint');

    function fmt(ts) {
      if (!ts) return 'Never';
      return new Intl.DateTimeFormat(undefined,{
        timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      }).format(new Date(ts));
    }
    function msToMMSS(ms) {
      const s = Math.max(0, Math.floor(ms/1000));
      const mm = Math.floor(s/60), ss = s % 60;
      return `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    }

    // Listen for remote updates to keep all devices in sync
    onSnapshot(counterRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        elCount.textContent = data.count ?? 0;
        elLast.textContent  = fmt(data.lastTap);
        const now  = Date.now();
        const next = data.nextAllowed || 0;
        if (now < next) {
          elTap.disabled = true;
          elHint.textContent = `Locked: ${msToMMSS(next - now)} remaining`;
        } else {
          elTap.disabled = false;
          elHint.textContent = '';
        }
      } else {
        // initialise document if it doesn't exist
        runTransaction(db, async (txn) => {
          txn.set(counterRef, { count:0, lastTap:null, nextAllowed:0 });
        });
      }
    });

    // Tap handler: run a transaction to enforce the lock and update state atomically
    elTap.addEventListener('click', async () => {
      try {
        await runTransaction(db, async (txn) => {
          const docSnap = await txn.get(counterRef);
          const data    = docSnap.data() || { count:0, lastTap:0, nextAllowed:0 };
          const now     = Date.now();
          if (now < (data.nextAllowed || 0)) return; // still locked; ignore tap
          txn.update(counterRef, {
            count: (data.count || 0) + 1,
            lastTap: now,
            nextAllowed: now + LOCK_MS
          });
        });
        if (navigator.vibrate) navigator.vibrate(10);
      } catch(e) {
        console.error('Tap failed', e);
      }
    });
  </script>
</body>
</html>
